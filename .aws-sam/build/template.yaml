AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "POSHub API - Template SAM minimal avec fonction, layer, r\xF4le et variables\
  \ d'environnement\n"
Parameters:
  Stage:
    Type: String
    Default: dev
    Description: "Environnement de d\xE9ploiement"
    AllowedValues:
    - dev
    - staging
    - prod
Resources:
  PosHubDependenciesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName:
        Fn::Sub: poshub-dependencies-${Stage}
      Description: "D\xE9pendances Python pour POSHub API"
      ContentUri: ..\..\layer.zip
      CompatibleRuntimes:
      - python3.13
      RetentionPolicy: Delete
  PosHubOrdersQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: poshub-orders-${Stage}-h
      VisibilityTimeout: 30
      MessageRetentionPeriod: 1209600
      ReceiveMessageWaitTimeSeconds: 20
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - PosHubOrdersDeadLetterQueue
          - Arn
        maxReceiveCount: 3
  PosHubOrdersDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: poshub-orders-dlq-${Stage}-h
      MessageRetentionPeriod: 1209600
  PosHubExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
      - PolicyName: SSMParameterAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - ssm:GetParameter
            - ssm:GetParameters
            Resource:
            - Fn::Sub: arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/pos/*
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource:
              Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*
      - PolicyName: SQSQueueAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
            - sqs:GetQueueUrl
            Resource:
            - Fn::GetAtt:
              - PosHubOrdersQueue
              - Arn
            - Fn::GetAtt:
              - PosHubOrdersDeadLetterQueue
              - Arn
  PosHubFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: poshub-api-${Stage}
      CodeUri: PosHubFunction
      Handler: src.poshub_api.main.lambda_handler
      Runtime: python3.13
      MemorySize: 512
      Timeout: 30
      Role:
        Fn::GetAtt:
        - PosHubExecutionRole
        - Arn
      Layers:
      - Ref: PosHubDependenciesLayer
      Environment:
        Variables:
          STAGE:
            Ref: Stage
          LOG_LEVEL: INFO
          API_KEY_PARAM:
            Fn::Sub: /pos/${Stage}/api-key
          QUEUE_URL_PARAM:
            Fn::Sub: /pos/${Stage}/queue-url
          PYTHONPATH: /var/task/src
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
        RootApiEvent:
          Type: Api
          Properties:
            Path: /
            Method: ANY
    Metadata:
      SamResourceId: PosHubFunction
  ApiKeyParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name:
        Fn::Sub: /pos/${Stage}/api-key
      Type: String
      Value:
        Fn::Sub: test-api-key-${Stage}-changeme
      Description:
        Fn::Sub: "Cl\xE9 API pour POSHub - ${Stage}"
  QueueUrlParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name:
        Fn::Sub: /pos/${Stage}/queue-url
      Type: String
      Value:
        Ref: PosHubOrdersQueue
      Description:
        Fn::Sub: URL de la queue SQS pour les commandes - ${Stage}
Outputs:
  PosHubApiUrl:
    Description: URL de l'API POSHub
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ApiUrl
  PosHubFunction:
    Description: ARN de la fonction Lambda POSHub
    Value:
      Fn::GetAtt:
      - PosHubFunction
      - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-FunctionArn
  PosHubLayer:
    Description: "ARN du layer de d\xE9pendances"
    Value:
      Ref: PosHubDependenciesLayer
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-LayerArn
  ExecutionRole:
    Description: "ARN du r\xF4le d'ex\xE9cution"
    Value:
      Fn::GetAtt:
      - PosHubExecutionRole
      - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ExecutionRoleArn
  PosHubOrdersQueueUrl:
    Description: URL de la queue SQS pour les commandes
    Value:
      Ref: PosHubOrdersQueue
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-OrdersQueueUrl
  PosHubOrdersQueueArn:
    Description: ARN de la queue SQS pour les commandes
    Value:
      Fn::GetAtt:
      - PosHubOrdersQueue
      - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-OrdersQueueArn
